# # 詩生態回路 Webプロトタイプ設計書 v0.1

目的：ブラウザ上で「詩を産む個体群」が世代交代し、文体の“種分化”が観察できる最小プロトタイプを作る。まずは**サーバーレス（静的サイト）**で公開可能な形を最優先。

> キーワード：言語遺伝子 / 代謝（栄養語）/ 健康診断（自動）/ 選好（人間介在・任意）/ 交叉・突然変異 / 種分化（ニッチ）/ 標本箱

---

## 1. 方式（公開と実装方針）

### 1-1. 公開方式

- **方式A：完全クライアント（ブラウザのみ）**
    
    - 世代生成・評価・繁殖・保存をすべてブラウザ内で実行
        
    - GitHub Pages 等の静的ホスティングで公開できる
        
    - データ保存：IndexedDB（推奨）／LocalStorage（最小）
        

※後から拡張：

- 方式B（サーバーで世代生成）や方式C（ユーザー提出）に拡張可能だが、v0.1は対象外。
    

---

## 2. v0.1のゴール（最小で“生命っぽさ”が見える）

### 2-1. できること（必須）

1. 個体30体を生成（遺伝子を持つ）
    
2. 栄養語セット（例：5語）を与える
    
3. 各個体が詩を生成
    
4. 自動の健康診断でスコア付け
    
5. 上位を親として交叉＋突然変異で次世代を生成
    
6. 各世代のログ（詩＋遺伝子＋親ID＋診断）を保存
    
7. UIで「今日の世代」「勝者（上位数体）」「標本箱」を閲覧
    

### 2-2. できたら嬉しい（任意）

- 週1回だけ人間が「好き」を選ぶ（繁殖権）
    
- 断定↔余韻、具体↔抽象の散布図（種分化が視覚化）
    

---

## 3. コア概念（人工生命としての設計）

### 3-1. 個体（Individual）

- 個体は「詩を産む器官＝遺伝子（Genome）」を持つ
    
- 詩そのものは遺伝子ではなく、**遺伝子が“生成規則”を規定**する
    

### 3-2. 環境（Environment）

- 栄養語（nutrients）を毎世代与える（最小5語）
    
- v0.1はユーザーがUIで入力 or プリセット選択
    

### 3-3. 生存（Survival）

- v0.1は美的評価はしない。**健康診断（ルール遵守）**だけ。
    
- 人間の選好は後段（任意）で追加。
    

### 3-4. 進化（Evolution）

- 選択：スコア上位K体が繁殖
    
- 交叉：遺伝子パラメータを混ぜる（一様交叉など）
    
- 突然変異：各パラメータに小さな揺らぎ
    

### 3-5. 種分化（Speciation / Niches）

- v0.1では「種」ラベルを固定で持たせるより、
    
    - 断定度／余韻度／具体度のパラメータが
        
    - 世代を通して偏り、**自然に“系統”っぽくなる**のを観察
        

---

## 4. データモデル（保存形式）

### 4-1. Genome（遺伝子）最小8項目

- lines: 行数（4–16）
    
- lineLen: 目標字数（8–24）
    
- assertiveness: 断定度（0–1）
    
- afterglow: 余韻度（0–1）
    
- concreteness: 具体度（0–1）
    
- repetition: 反復率（0–1）
    
- nutrientMix: 栄養混入率（0–1）
    
- immunity: 免疫（毒回避傾向）（0–1）
    

制約（推奨）：

- assertiveness と afterglow は同時に高くなり過ぎないよう軽く制限（例：合計が一定以上なら片方を抑える）
    

### 4-2. Individual

- id: string
    
- parentIds: string[]
    
- genome: Genome
    

### 4-3. GenerationRecord（世代ログ1個体分）

- runId: string
    
- generation: number
    
- individualId: string
    
- parentIds: string[]
    
- genome: Genome
    
- nutrients: string[]
    
- toxicWords: string[]
    
- poem: string
    
- meta:
    
    - usedNutrients: string[]
        
    - stats: 文字数・行数など
        
- score: number
    
- diag:
    
    - reasons: string[]（starved/poisoned/structure broken 等）
        

保存先：IndexedDB（推奨）

- objectStore: runs / generations / individuals / settings など
    

---

## 5. 詩生成（LLMなしのv0.1）

目的：まず「回る」こと。

- v0.1はテンプレ＋語彙プールで生成する。
    
- 後で差し替え可能にする（生成関数を1箇所に閉じ込める）。
    

### 5-1. 語彙プール

- concretePool: 感覚語＋栄養語
    
- abstractPool: 抽象語＋栄養語
    

### 5-2. 行生成ルール（例）

- 行ごとに concrete/abstract を genome.concreteness で選ぶ
    
- nutrients を genome.nutrientMix の確率で混ぜる（最低1回は混ぜる）
    
- repetition に応じて直前トークンを再利用
    
- 最終行の文末は assertiveness/afterglow の大小で「断定系」or「余韻系」を選ぶ
    

---

## 6. 健康診断（自動スコア：美ではなく生存）

### 6-1. ルール例

- 代謝：栄養語を最低1語含む → +
    
- 毒：toxicWords を含む → 大幅減点（死亡扱いでも可）
    
- 構造：行数が範囲内、極端な長文がない → +
    
- 反復発作：文字のユニーク率が極端に低い／同語連打 → 減点
    

### 6-2. スコア設計

- スコアは「選択のための近似」でよい（厳密さ不要）
    
- 目的は“指標ハック”よりも「破綻を淘汰する」こと
    

---

## 7. UI（ブラウザ表示の最小）

### 7-1. 画面構成

1. **Controls**
    
    - 個体数（既定30）
        
    - 世代数（既定3）
        
    - 栄養語入力（カンマ区切り）or プリセット
        
    - 毒語入力（任意）
        
    - [Run] ボタン / [Reset] ボタン
        
2. **Current Generation**
    
    - 上位3体の詩（score付き）
        
    - クリックで詳細（遺伝子・診断）
        
3. **Speciation View（任意・できたら）**
    
    - 散布図：x=assertiveness-afterglow、y=concreteness
        
    - 点クリックで詩表示
        
4. **Specimen Box（標本箱）**
    
    - 各世代の代表個体（例：上位3）をカード表示
        
    - 「この個体を保存（お気に入り）」
        
5. **Run History**
    
    - 過去のrunId一覧、クリックで再表示
        

### 7-2. 人間介在（任意）

- 「今週の繁殖権：3つ選ぶ」UI
    
- 選んだ個体にボーナスを与えて次世代へ（選好を環境因子として入れる）
    

---

## 8. ルールセット（プリセット案）

### 8-1. 栄養語プリセット

- Garden: ルッコラ, フェンネル, 瓶, 水, 風
    
- Work: 注意, 許諾, 赤字, 待機, 期限
    
- Cosmic: 時間, 真空, 光, 境界, 余白
    

### 8-2. 毒語プリセット（任意）

- 危険：許諾不明, 注意！！（など）
    

---

## 9. 実装構成（Codex向けタスク分割）

### 9-1. モジュール

- domain/
    
    - genome.ts（型・生成・交叉・突然変異・制約）
        
    - poem.ts（詩生成：テンプレ方式）
        
    - health.ts（健康診断・スコア）
        
    - evolution.ts（選択→繁殖→次世代）
        
- storage/
    
    - db.ts（IndexedDBラッパ：runs保存/読込）
        
- ui/
    
    - components（Controls, Winners, SpecimenBox, RunHistory）
        
    - state（runState）
        
- app.ts（起動・ルーティングなしの単一ページでも可）
    

### 9-2. マイルストーン

- M0：静的ページでUI骨組み（入力→Runボタン→結果枠）
    
- M1：世代1の生成と表示（個体30、上位3表示）
    
- M2：世代Nまで回す（既定3）
    
- M3：IndexedDB保存とRun履歴表示
    
- M4（任意）：散布図で種分化ビュー
    
- M5（任意）：週1の人間選好（繁殖権）
    

---

## 10. 受け入れ基準（v0.1完成の判定）

- ブラウザでRunすると、世代1〜3が回り、上位詩が表示される
    
- 世代ログが保存され、リロード後も過去Runを閲覧できる
    
- 栄養語を変えると挙動（詩の語彙）が変わる
    
- 断定／余韻／具体の傾向が、個体ごとに差として見える
    

---

## 11. 将来拡張（v0.2以降の余地）

- LLM差し替え（poem生成だけ差し替える）
    
- ユーザー提出（ハイブリッド方式C）
    
- 系統樹ビュー（親子関係の可視化）
    
- “代謝”を濃度ベースにして環境をリッチ化
    

---

## 12. Codexに渡す際の依頼文（コピペ用）

- この設計書に従って、TypeScript/JavaScriptで静的サイト（GitHub Pages想定）のSPAを作ってください。
    
- サーバー不要。データはIndexedDBに保存。
    
- v0.1はテンプレ式の詩生成（LLMなし）でOK。
    
- UIは Controls / Winners / SpecimenBox / RunHistory を最低限実装。
    
- まずM0→M3までを確実に完成させてください。

---

## 13. 改善提案（v0.1の実装を安定させる追記）

たたき台として非常に良いので、下記を足すと「回る」「直せる」「観察できる」がさらに強くなる。

### 13-1. 再現性（Reproducibility）

- run単位で `seed`（乱数シード）を必ず保存する
    
- `runId + seed + nutrients + toxicWords + generationCount` があれば、同条件を再実行できる
    
- デバッグ時は「同じseedで再現」を基本手順にする
    

### 13-2. スコアの分解保存（調整しやすさ）

- `score` のみでなく、内訳も保存する
    
    - metabolismScore
        
    - structureScore
        
    - toxinPenalty
        
    - repetitionPenalty
        
- 例：`totalScore = metabolismScore + structureScore - toxinPenalty - repetitionPenalty`
    
- 目的：重み調整時に「どのルールが効き過ぎているか」を可視化する
    

### 13-3. 「死亡」と「減点」の分離（進化安定）

- 毒語判定は `isDead` を持たせ、通常減点と別管理にする
    
- `isDead=true` は繁殖候補から除外（または極低確率）
    
- これにより、進化ロジックが明快になり挙動がぶれにくい
    

### 13-4. 多様性維持（早期単一化の防止）

- 親選択を「上位のみ」ではなく、次で構成する
    
    - elite枠：上位K体
        
    - diversity枠：残りからランダムM体
        
- 目安：`K=6, M=2`（個体30の場合）
    
- 目的：局所最適への収束を遅らせ、種分化の観察性を上げる
    

### 13-5. データスキーマの版管理（将来の破壊回避）

- IndexedDBに `schemaVersion` を持たせる
    
- `settings` または `runs` に版情報を保存し、読み込み時にmigration分岐する
    
- v0.1時点で `v1` を定義しておくと、v0.2以降の変更に耐えやすい
    

### 13-6. 観察性の最小強化（任意だが効果大）

- 世代ごとに「多様性指標」を1つ保存する（例：genome分散の平均）
    
- UIで親→子の差分を1行表示する（例：`assertiveness +0.12`）
    
- これだけで「進化している感」が一気に伝わる
    

---

## 14. M0〜M3 実装チェックリスト（そのまま着手用）

### 14-1. M0：UI骨組み（入力→Run→結果枠）

- [ ] 単一ページを起動できる（`index.html` + `app.ts`/`main.ts`）
- [ ] Controls を表示（個体数、世代数、栄養語、毒語）
- [ ] `Run` / `Reset` ボタンを実装
- [ ] 結果表示枠（Winners / SpecimenBox / RunHistory）を空状態で表示
- [ ] 最低限のバリデーション（栄養語が空なら警告）

完了条件：
- [ ] 画面操作だけで入力値を保持でき、`Run` 押下でダミー結果が表示される

### 14-2. M1：世代1の生成と表示（個体30、上位3）

- [ ] `Genome` 型と初期生成関数を実装（制約込み）
- [ ] 個体30体を生成（`id`, `parentIds`, `genome`）
- [ ] テンプレ式 `poem` 生成関数を実装（栄養語最低1回）
- [ ] 健康診断を実装（代謝/毒/構造/反復）
- [ ] `score` と `scoreBreakdown` を保存
- [ ] 上位3体をWinnersに表示（詩 + score）
- [ ] 個体詳細で遺伝子/診断理由を表示

完了条件：
- [ ] 1回のRunで30詩が生成され、上位3体が一貫して表示される

### 14-3. M2：世代Nまで進化（既定3）

- [ ] 世代ループを実装（1→N）
- [ ] 親選択を実装（`elite + diversity`）
- [ ] 交叉（一様交叉など）を実装
- [ ] 突然変異（小幅揺らぎ、0-1クランプ）を実装
- [ ] `isDead` と通常減点を分離して扱う
- [ ] run単位で `seed` を保存し、再現実行できる

完了条件：
- [ ] 同じ`seed`・同じ入力で再実行すると同一結果になる
- [ ] 3世代分の勝者と標本が表示される

### 14-4. M3：IndexedDB保存とRun履歴

- [ ] IndexedDBラッパを実装（`runs`, `generations`, `settings`）
- [ ] `schemaVersion` を導入（v1）
- [ ] 世代ごとの `GenerationRecord` を保存
- [ ] Run完了時に runメタ情報（seed、入力条件、世代数）を保存
- [ ] RunHistory一覧表示 + 過去Run再表示を実装
- [ ] リロード後も履歴が残ることを確認

完了条件：
- [ ] 過去Runを選ぶと、その時点のWinners/SpecimenBoxが復元される

### 14-5. 最終確認（v0.1）

- [ ] 受け入れ基準（Section 10）をすべて満たす
- [ ] 栄養語プリセット切替で語彙傾向が変化する
- [ ] 毒語入力で死亡判定が機能する
- [ ] コンソールエラーなしで主要操作を一巡できる

---

月野テンプレクス
